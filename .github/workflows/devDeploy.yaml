name: Deploy KuchiAPI to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      DIRECT_URL: ${{ secrets.DIRECT_URL }}
      SCHEMA: ${{ secrets.SCHEMA }}
      PORT: ${{ secrets.PORT }}
      JWT_SECRET_RESTAURANT: ${{ secrets.JWT_SECRET_RESTAURANT }}
      JWT_PRIVATE_KEY_RESTAURANT: ${{ secrets.JWT_PRIVATE_KEY_RESTAURANT }}
      JWT_PUBLIC_KEY_RESTAURANT: ${{ secrets.JWT_PUBLIC_KEY_RESTAURANT }}
      VPS_HOST: srv716497.hstgr.cloud  # Substitua pelo seu hostname
      VPS_USER: root  # Substitua pelo seu usu√°rio SSH
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      SSH_KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}

    steps:
      - name: üõéÔ∏è Checkout do c√≥digo
        uses: actions/checkout@v3

      - name: Ajustar permiss√µes da chave SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Adicionar chave do host ao known_hosts
        run: |
          mkdir -p ~/.ssh
          echo "${{ env.SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Testar conex√£o SSH com debug
        run: |
          ssh -vvv -i ~/.ssh/id_rsa ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "echo Conex√£o SSH bem-sucedida!"

      - name: üöÄ Deploy via SSH na VPS
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USER }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "üîß Iniciando o processo de deploy.."

            # Vari√°veis
            APP_DIR="/root/ewertonigor/kuchiapi"  # Use um caminho absoluto

            # Verificando Docker e Docker Compose
            echo "üî® Verificando Docker e Docker Compose..."
            docker --version || (echo "Docker n√£o instalado!" && exit 1)
            docker-compose --version || docker compose version || (echo "Docker Compose n√£o instalado!" && exit 1)

            echo "üìÅ Verificando diret√≥rio..."
            if [ ! -d "$APP_DIR" ]; then
              echo "Criando diret√≥rio da aplica√ß√£o..."
              mkdir -p $APP_DIR
            fi

            echo "üîÑ Atualizando c√≥digo..."
            cd $APP_DIR
            if [ ! -d ".git" ]; then
              echo "Reposit√≥rio n√£o encontrado. Clonando..."
              git clone https://github.com/Nume-Softwares/kuche-api.git .
            else
              echo "Reposit√≥rio encontrado. Fazendo pull..."
              git pull origin main
            fi

            # Rodando o build do NestJS
            if [ -f "package.json" ]; then
              echo "üî® Instalando depend√™ncias e compilando a aplica√ß√£o..."
              npm ci
              npm run build
            else
              echo "‚ùå ERRO: Arquivo package.json n√£o encontrado!"
              exit 1
            fi

            echo "üê≥ Subindo containers..."
            docker-compose down || docker compose down
            docker-compose up -d --build || docker compose up -d --build

            echo "‚úÖ Deploy finalizado!"

              uses: appleboy/ssh-action@v0.1.7
              with:
                host: ${{ env.VPS_HOST }}
                username: ${{ env.VPS_USER }}
                key: ${{ env.SSH_PRIVATE_KEY }}
                port: 22
                script: |
                  echo "üîß Iniciando o processo de deploy..."
                  
                  # Vari√°veis
                  APP_DIR="/root/ewertonigor/kuchiapi"  # Verifique o caminho correto para o seu diret√≥rio da aplica√ß√£o

                  # Verificando Docker e Docker Compose
                  echo "üî® Verificando Docker e Docker Compose..."
                  docker --version || (echo "Docker n√£o instalado!" && exit 1)
                  docker-compose --version || (echo "Docker Compose n√£o instalado!" && exit 1)

                  echo "üìÅ Verificando diret√≥rio..."
                  if [ ! -d "$APP_DIR" ]; then
                    echo "Criando diret√≥rio da aplica√ß√£o..."
                    mkdir -p $APP_DIR
                  fi

                  echo "üîÑ Atualizando c√≥digo..."
                  cd $APP_DIR
                  git pull || git clone git@github.com:Nume-Softwares/kuche-api.git .  # Substitua com seu reposit√≥rio correto

                  # Rodando o build do NestJS
                  echo "üî® Instalando depend√™ncias e compilando a aplica√ß√£o NestJS..."
                  npm ci  # Garantir que as depend√™ncias sejam instaladas de maneira limpa
                  npm run build  # Compilando o c√≥digo TypeScript para JavaScript

                  echo "üê≥ Subindo containers..."
                  docker-compose down  # Parando containers antigos
                  docker-compose up -d --build  # Reconstruindo e subindo os containers

                  echo "‚úÖ Deploy finalizado!"