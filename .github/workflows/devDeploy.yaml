name: Deploy KuchiAPI to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      DIRECT_URL: ${{ secrets.DIRECT_URL }}
      SCHEMA: ${{ secrets.SCHEMA }}
      PORT: ${{ secrets.PORT }}
      JWT_SECRET_RESTAURANT: ${{ secrets.JWT_SECRET_RESTAURANT }}
      JWT_PRIVATE_KEY_RESTAURANT: ${{ secrets.JWT_PRIVATE_KEY_RESTAURANT }}
      JWT_PUBLIC_KEY_RESTAURANT: ${{ secrets.JWT_PUBLIC_KEY_RESTAURANT }}
      VPS_HOST: ${{ vars.VPS_HOST }}
      VPS_USER: ${{ vars.VPS_USER }}
      SSH_PRIVATE_KEY: ${{ vars.SSH_PRIVATE_KEY }}

    steps:
      - name: ğŸ›ï¸ Checkout do cÃ³digo
        uses: actions/checkout@v3

      - name: ğŸš€ Deploy via SSH na VPS
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USER }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          port: 22  # Confirmando que a porta Ã© 22 para SSH
          script: |
            echo "ğŸ”§ Iniciando o processo de deploy..."
            
            # VariÃ¡veis
            APP_DIR="/root/ewertonigor/kuchiapi"  # Verifique o caminho correto para o seu diretÃ³rio da aplicaÃ§Ã£o

            # Verificando Docker e Docker Compose
            echo "ğŸ”¨ Verificando Docker e Docker Compose..."
            docker --version || (echo "Docker nÃ£o instalado!" && exit 1)
            docker-compose --version || (echo "Docker Compose nÃ£o instalado!" && exit 1)

            echo "ğŸ“ Verificando diretÃ³rio..."
            if [ ! -d "$APP_DIR" ]; then
              echo "Criando diretÃ³rio da aplicaÃ§Ã£o..."
              mkdir -p $APP_DIR
            fi

            echo "ğŸ”„ Atualizando cÃ³digo..."
            cd $APP_DIR
            git pull || git clone git@github.com:Nume-Softwares/kuche-api.git .  # Substitua com seu repositÃ³rio correto

            # Rodando o build do NestJS
            echo "ğŸ”¨ Instalando dependÃªncias e compilando a aplicaÃ§Ã£o NestJS..."
            npm ci  # Garantir que as dependÃªncias sejam instaladas de maneira limpa
            npm run build  # Compilando o cÃ³digo TypeScript para JavaScript

            echo "ğŸ³ Subindo containers..."
            docker-compose down  # Parando containers antigos
            docker-compose up -d --build  # Reconstruindo e subindo os containers

            echo "âœ… Deploy finalizado!"

      - name: ğŸ› ï¸ Debugging SSH Connection
        run: |
          echo "ğŸ” Debugando a conexÃ£o SSH..."
          ssh -vvv -i ~/.ssh/id_rsa root@${{ secrets.VPS_HOST }} "echo ConexÃ£o SSH bem-sucedida!"
      - name: ğŸ›ï¸ Checkout do cÃ³digo
        uses: actions/checkout@v3

      - name: ğŸ§‘â€ğŸ’» Testando a conexÃ£o DNS
        run: |
          nslookup ${{ env.VPS_HOST }}
          ping -c 4 ${{ env.VPS_HOST }}

      - name: ğŸš€ Deploy via SSH na VPS
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ env.VPS_HOST }} 
          username: ${{ env.VPS_USER }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # VariÃ¡veis
            APP_DIR="/root/ewertonigor/kuchiapi"  # Verifique o caminho correto para o seu diretÃ³rio da aplicaÃ§Ã£o

            # Verificando Docker e Docker Compose
            echo "ğŸ”¨ Verificando Docker e Docker Compose..."
            docker --version || (echo "Docker nÃ£o instalado!" && exit 1)
            docker-compose --version || (echo "Docker Compose nÃ£o instalado!" && exit 1)

            echo "ğŸ“ Verificando diretÃ³rio..."
            if [ ! -d "$APP_DIR" ]; then
              echo "Criando diretÃ³rio da aplicaÃ§Ã£o..."
              mkdir -p $APP_DIR
            fi

            echo "ğŸ”„ Atualizando cÃ³digo..."
            cd $APP_DIR
            git pull || git clone git@github.com:Nume-Softwares/kuche-api.git .  # Substitua com seu repositÃ³rio correto

            # Rodando o build do NestJS
            echo "ğŸ”¨ Instalando dependÃªncias e compilando a aplicaÃ§Ã£o NestJS..."
            npm ci  # Garantir que as dependÃªncias sejam instaladas de maneira limpa
            npm run build  # Compilando o cÃ³digo TypeScript para JavaScript

            echo "ğŸ³ Subindo containers..."
            docker-compose down  # Parando containers antigos
            docker-compose up -d --build  # Reconstruindo e subindo os containers

            echo "âœ… Deploy finalizado!"
